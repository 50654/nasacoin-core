name: Build and Release NASA Coin

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on tags like v1.0.0

jobs:
  test-and-build:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: |
          npm ci

      - name: üß™ Run Smart Contract Tests
        run: |
          npm test

      - name: üîç Security Audit
        run: |
          npm audit --audit-level moderate

      - name: üèóÔ∏è Build Dashboard
        run: |
          npm run build:dashboard

      - name: üì¶ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            dist/
            artifacts/

  build:
    needs: test-and-build
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch full history for version detection

      - name: ‚öôÔ∏è Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential libtool autotools-dev automake pkg-config \
            libssl-dev libevent-dev bsdmainutils libboost-all-dev \
            libdb-dev libdb++-dev git fakeroot dpkg-dev \
            libminiupnpc-dev libnatpmp-dev libzmq3-dev \
            libqrencode-dev libprotobuf-dev protobuf-compiler \
            nodejs npm curl

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Download Test Artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: .

      - name: üì¶ Install Node.js dependencies
        run: |
          npm ci
          npm run compile

      - name: üîç Detect version from tag
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}  # Remove 'v' prefix if present
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: üß™ Run Smart Contract Tests
        run: |
          echo "Running NASA Coin smart contract tests..."
          npm test
          echo "‚úÖ Smart contract tests passed"

      - name: üèóÔ∏è Build Dashboard
        run: |
          echo "Building NASA Coin dashboard..."
          npm run build:dashboard
          echo "‚úÖ Dashboard build completed"

      - name: üîß Build NASA Coin Core
        run: |
          cd bitcoin-core
          
          # Check if Bitcoin source exists
          if [ ! -f "./autogen.sh" ]; then
            echo "‚ùå Bitcoin source not found in bitcoin-core directory"
            echo "Please ensure Bitcoin source code is cloned into bitcoin-core/"
            exit 1
          fi
          
          # Clean previous build
          make clean || true
          
          # Generate configure script
          ./autogen.sh
          
          # Configure build with NASA Coin specific options
          ./configure \
            --disable-wallet \
            --disable-gui \
            --enable-debug \
            --with-incompatible-bdb \
            --without-miniupnpc \
            --without-natpmp \
            --without-zmq \
            --without-qrencode
          
          # Build with all available cores
          make -j$(nproc)
          
          # Verify build
          if [ ! -f "./src/bitcoind" ] || [ ! -f "./src/bitcoin-cli" ] || [ ! -f "./src/bitcoin-tx" ]; then
            echo "‚ùå Build failed - required binaries not found"
            exit 1
          fi
          
          echo "‚úÖ NASA Coin Core build completed successfully"

      - name: üê≥ Build Docker Image
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Building Docker image for NASA Coin v$VERSION..."
          
          # Build Docker image
          docker build -t nasacoin:$VERSION .
          docker tag nasacoin:$VERSION nasacoin:latest
          
          # Save Docker image as tar
          docker save nasacoin:$VERSION | gzip > release/nasacoin-$VERSION-docker.tar.gz
          
          echo "‚úÖ Docker image built successfully"

      - name: üì¶ Package Release Artifacts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p release/nasacoin-$VERSION/bin
          mkdir -p release/nasacoin-$VERSION/share/nasacoin
          mkdir -p release/nasacoin-$VERSION/dashboard
          mkdir -p release/nasacoin-$VERSION/contracts
          
          # Copy core binaries and rename them
          cp bitcoin-core/src/bitcoind release/nasacoin-$VERSION/bin/nasacoind
          cp bitcoin-core/src/bitcoin-cli release/nasacoin-$VERSION/bin/nasacoin-cli
          cp bitcoin-core/src/bitcoin-tx release/nasacoin-$VERSION/bin/nasacoin-tx
          
          # Copy dashboard files
          cp -r dist/* release/nasacoin-$VERSION/dashboard/
          
          # Copy smart contract artifacts
          cp -r artifacts/ release/nasacoin-$VERSION/contracts/
          cp contracts/NASACoin.sol release/nasacoin-$VERSION/contracts/
          
          # Set executable permissions
          chmod +x release/nasacoin-$VERSION/bin/*
          
          # Create comprehensive configuration file
          cat > release/nasacoin-$VERSION/share/nasacoin/nasacoin.conf << 'EOF'
          # NASA Coin Configuration File
          # 
          # Network settings
          testnet=0
          regtest=0
          
          # Connection settings
          listen=1
          port=8333
          
          # RPC settings
          server=1
          rpcuser=nasacoin
          rpcpassword=your_secure_password_here
          rpcport=8332
          
          # Mining settings (adjust as needed)
          gen=0
          
          # Logging
          debug=0
          EOF
          
          # Create comprehensive README
          cat > release/nasacoin-$VERSION/README.txt << 'EOF'
          NASA Coin v$VERSION
          =================
          
          This is NASA Coin, a comprehensive cryptocurrency ecosystem including:
          - High-reward experimental cryptocurrency (Bitcoin fork)
          - ERC-20 smart contract on Ethereum
          - Web dashboard for management
          - Docker containerization
          
          Components:
          - bin/: Core daemon and CLI tools
          - dashboard/: Web interface
          - contracts/: Smart contract artifacts
          - share/nasacoin/: Configuration files
          
          Installation:
          1. Copy the bin/ directory to your PATH or run from this directory
          2. Copy nasacoin.conf to ~/.nasacoin/ and customize as needed
          3. Run: ./nasacoind -daemon
          4. Use: ./nasacoin-cli getinfo
          5. Open dashboard/index.html in your browser
          
          Docker:
          - Load: docker load < nasacoin-$VERSION-docker.tar.gz
          - Run: docker run -d nasacoin:$VERSION
          
          Smart Contract:
          - Deploy using artifacts in contracts/ directory
          - Use with MetaMask or other Web3 wallets
          
          For more information, visit: https://github.com/your-org/nasacoin
          EOF
          
          echo "‚úÖ Release artifacts packaged successfully"

      - name: üì¶ Create .tar.gz installer
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd release
          tar -czvf nasacoin-$VERSION-linux.tar.gz nasacoin-$VERSION/
          echo "‚úÖ Created nasacoin-$VERSION-linux.tar.gz"
          
          # Create separate dashboard package
          tar -czvf nasacoin-dashboard-$VERSION.tar.gz nasacoin-$VERSION/dashboard/
          echo "‚úÖ Created nasacoin-dashboard-$VERSION.tar.gz"

      - name: üì¶ Create .deb installer
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="amd64"
          
          # Create Debian package structure
          mkdir -p nasacoin-deb/DEBIAN
          mkdir -p nasacoin-deb/usr/local/bin
          mkdir -p nasacoin-deb/usr/share/nasacoin
          mkdir -p nasacoin-deb/usr/share/doc/nasacoin
          
          # Copy binaries
          cp release/nasacoin-$VERSION/bin/* nasacoin-deb/usr/local/bin/
          
          # Copy configuration and documentation
          cp release/nasacoin-$VERSION/share/nasacoin/* nasacoin-deb/usr/share/nasacoin/
          cp release/nasacoin-$VERSION/README.txt nasacoin-deb/usr/share/doc/nasacoin/
          
          # Create control file
          cat > nasacoin-deb/DEBIAN/control << EOF
          Package: nasacoin
          Version: $VERSION
          Section: net
          Priority: optional
          Architecture: $ARCH
          Depends: libc6 (>= 2.27), libssl1.1 (>= 1.1.0), libevent-2.1-6 (>= 2.1.8)
          Maintainer: Wesley S. Baker <wesley@nasacoin.org>
          Description: NASA Coin - High-reward experimental cryptocurrency
           NASA Coin is a high-reward experimental cryptocurrency forked from Bitcoin.
           This package provides the core daemon (nasacoind), CLI client (nasacoin-cli),
           and transaction tool (nasacoin-tx).
           .
           Features:
            - High reward mining
            - Bitcoin-compatible protocol
            - Command-line interface
            - Transaction processing
          EOF
          
          # Create postinst script
          cat > nasacoin-deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          
          # Create nasacoin user if it doesn't exist
          if ! id nasacoin >/dev/null 2>&1; then
            useradd --system --home-dir /var/lib/nasacoin --shell /bin/false nasacoin
          fi
          
          # Create data directory
          mkdir -p /var/lib/nasacoin
          chown nasacoin:nasacoin /var/lib/nasacoin
          
          # Create config directory
          mkdir -p /etc/nasacoin
          if [ ! -f /etc/nasacoin/nasacoin.conf ]; then
            cp /usr/share/nasacoin/nasacoin.conf /etc/nasacoin/
            chown nasacoin:nasacoin /etc/nasacoin/nasacoin.conf
            chmod 600 /etc/nasacoin/nasacoin.conf
          fi
          
          echo "NASA Coin installed successfully!"
          echo "Configuration: /etc/nasacoin/nasacoin.conf"
          echo "Data directory: /var/lib/nasacoin"
          echo "Run: nasacoind -daemon"
          EOF
          
          chmod +x nasacoin-deb/DEBIAN/postinst
          
          # Build package
          dpkg-deb --build nasacoin-deb
          mv nasacoin-deb.deb release/nasacoin_${VERSION}_${ARCH}.deb
          
          echo "‚úÖ Created nasacoin_${VERSION}_${ARCH}.deb"

      - name: üöÄ Create GitHub Release with Installers
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: NASA Coin ${{ steps.version.outputs.version }}
          body: |
            ## üöÄ NASA Coin ${{ steps.version.outputs.version }}
            
            ### Downloads
            - **Complete Package (tar.gz)**: `nasacoin-${{ steps.version.outputs.version }}-linux.tar.gz`
            - **Dashboard Only**: `nasacoin-dashboard-${{ steps.version.outputs.version }}.tar.gz`
            - **Docker Image**: `nasacoin-${{ steps.version.outputs.version }}-docker.tar.gz`
            - **Debian/Ubuntu (.deb)**: `nasacoin_${{ steps.version.outputs.version }}_amd64.deb`
            
            ### Installation
            
            **Complete Package:**
            ```bash
            tar -xzf nasacoin-${{ steps.version.outputs.version }}-linux.tar.gz
            cd nasacoin-${{ steps.version.outputs.version }}
            ./bin/nasacoind -daemon
            # Open dashboard/index.html in your browser
            ```
            
            **Docker:**
            ```bash
            docker load < nasacoin-${{ steps.version.outputs.version }}-docker.tar.gz
            docker run -d -p 8333:8333 -p 18334:18334 nasacoin:${{ steps.version.outputs.version }}
            ```
            
            **From .deb package:**
            ```bash
            sudo dpkg -i nasacoin_${{ steps.version.outputs.version }}_amd64.deb
            nasacoind -daemon
            ```
            
            ### What's New
            - High-reward experimental cryptocurrency (Bitcoin fork)
            - ERC-20 smart contract on Ethereum
            - Web dashboard for management
            - Docker containerization
            - Command-line interface included
            - Easy installation packages
            
            ### Components
            - **Core**: Bitcoin-based cryptocurrency daemon
            - **Smart Contract**: ERC-20 token on Ethereum
            - **Dashboard**: Web interface for management
            - **Docker**: Containerized deployment
            
            ### Support
            - Documentation: [README](https://github.com/${{ github.repository }})
            - Issues: [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          files: |
            release/nasacoin-${{ steps.version.outputs.version }}-linux.tar.gz
            release/nasacoin-dashboard-${{ steps.version.outputs.version }}.tar.gz
            release/nasacoin-${{ steps.version.outputs.version }}-docker.tar.gz
            release/nasacoin_${{ steps.version.outputs.version }}_amd64.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-multi-platform:
    needs: test-and-build
    permissions:
      contents: read
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: darwin

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v5

      - name: ‚öôÔ∏è Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential libtool autotools-dev automake pkg-config \
            libssl-dev libevent-dev bsdmainutils libboost-all-dev \
            libdb-dev libdb++-dev git

      - name: ‚öôÔ∏è Install build dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install autoconf automake libtool pkg-config \
            boost libevent openssl berkeley-db4

      - name: ‚öôÔ∏è Install build dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install -y mingw make

      - name: üîß Build NASA Coin Core
        run: |
          cd bitcoin-core
          
          if [ ! -f "./autogen.sh" ]; then
            echo "‚ùå Bitcoin source not found"
            exit 1
          fi
          
          make clean || true
          ./autogen.sh
          
          if [ "${{ matrix.platform }}" = "windows" ]; then
            ./configure --disable-wallet --disable-gui
          else
            ./configure --disable-wallet --disable-gui --without-miniupnpc --without-natpmp
          fi
          
          make -j$(nproc)

      - name: üì¶ Package for Platform
        run: |
          VERSION="${{ github.ref_name#v }}"
          PLATFORM="${{ matrix.platform }}"
          
          mkdir -p release/nasacoin-$VERSION-$PLATFORM/bin
          
          if [ "$PLATFORM" = "windows" ]; then
            cp bitcoin-core/src/bitcoind.exe release/nasacoin-$VERSION-$PLATFORM/bin/nasacoind.exe
            cp bitcoin-core/src/bitcoin-cli.exe release/nasacoin-$VERSION-$PLATFORM/bin/nasacoin-cli.exe
            cp bitcoin-core/src/bitcoin-tx.exe release/nasacoin-$VERSION-$PLATFORM/bin/nasacoin-tx.exe
          else
            cp bitcoin-core/src/bitcoind release/nasacoin-$VERSION-$PLATFORM/bin/nasacoind
            cp bitcoin-core/src/bitcoin-cli release/nasacoin-$VERSION-$PLATFORM/bin/nasacoin-cli
            cp bitcoin-core/src/bitcoin-tx release/nasacoin-$VERSION-$PLATFORM/bin/nasacoin-tx
            chmod +x release/nasacoin-$VERSION-$PLATFORM/bin/*
          fi
          
          cd release
          if [ "$PLATFORM" = "windows" ]; then
            powershell Compress-Archive -Path nasacoin-$VERSION-$PLATFORM -DestinationPath nasacoin-$VERSION-$PLATFORM.zip
          else
            tar -czvf nasacoin-$VERSION-$PLATFORM.tar.gz nasacoin-$VERSION-$PLATFORM/
          fi

      - name: üì§ Upload Platform Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nasacoin-${{ matrix.platform }}
          path: release/

  docker-build:
    needs: test-and-build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v5

      - name: üîç Detect version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}:latest
          platforms: linux/amd64,linux/arm64
